# 精灵图处理工具设计文档

## 概述

一个 macOS 桌面应用，用于处理图片并生成 Phaser 游戏引擎可用的精灵图集。

## 技术栈

- **前端**: React + TypeScript
- **后端**: Tauri (Rust)
- **目标引擎**: Phaser (JSON Hash 格式)

## 架构

```
┌─────────────────────────────────────────────┐
│           Tauri Desktop App                 │
├─────────────────────────────────────────────┤
│  Frontend (React + TypeScript)              │
│  ├── 预处理模块 UI                           │
│  │   ├── 图片加载/预览                       │
│  │   ├── 颜色拾取器 + 消除控制               │
│  │   └── 分割线编辑器（可拖动）              │
│  └── Atlas 拼接模块 UI                       │
│      ├── 图片分组管理                        │
│      ├── 预览画布                            │
│      └── 导出设置                            │
├─────────────────────────────────────────────┤
│  Backend (Rust)                             │
│  ├── 图像处理（image crate）                 │
│  │   ├── 颜色消除算法                        │
│  │   └── 图片分割/裁剪                       │
│  └── Atlas 打包（bin packing 算法）          │
│      ├── MaxRects 紧密排列                   │
│      └── Phaser JSON Hash 生成              │
└─────────────────────────────────────────────┘
```

## 模块一：预处理

### 功能

1. **加载图片**: 支持 JPG/PNG 格式
2. **颜色消除**: 消除指定颜色（支持多次消除）
3. **图片分割**: 按行列分割，可拖动调整分割线
4. **导出**: 输出分割后的 PNG 图片

### 界面布局

```
┌──────────────────────────────────────────────────┐
│  [打开图片]                                       │
├────────────────────────┬─────────────────────────┤
│                        │  消除颜色列表            │
│                        │  ┌─────────────────────┐│
│                        │  │ ■ #FF00FF [30] [×]  ││
│      图片预览区         │  │ ■ #00FF00 [25] [×]  ││
│    （可缩放/平移）      │  │ ■ #FFFFFF [10] [×]  ││
│                        │  │ [+ 点击图片添加颜色] ││
│    点击拾取颜色 →       │  └─────────────────────┘│
│    拖动调整分割线       │  分割设置               │
│                        │  ┌─────────────────────┐│
│                        │  │ 行数: [3]  列数: [4] ││
│                        │  │ ☑ 显示分割线        ││
│                        │  └─────────────────────┘│
│                        │                         │
│                        │  [预览效果] [导出分割图]│
└────────────────────────┴─────────────────────────┘
```

### 颜色消除

- 支持多次消除（处理多色背景）
- 每个颜色独立容差设置（0-100 滑块）
- 实时预览效果（透明区域显示棋盘格）

### 分割功能

- 输入行列数自动生成等分线
- 分割线可拖动微调
- 拖动限制：不能越过相邻线
- 导出命名：纯序号 `0.png`, `1.png`...（从左到右，从上到下）

## 模块二：Atlas 拼接

### 功能

1. **导入图片**: 从文件系统或预处理模块导入
2. **分组管理**: 按 人物 > 动作 > 帧 层级组织
3. **紧密排列**: MaxRects bin packing 算法
4. **导出**: PNG 图集 + Phaser JSON Hash

### 界面布局

```
┌─────────────────────────────────────────────────────────┐
│  [添加图片] [从预处理导入] [清空]                         │
├─────────────────────────┬───────────────────────────────┤
│  图片分组管理            │        Atlas 预览             │
│  ┌─────────────────────┐│                               │
│  │ ▼ player           ││    ┌────────────────────┐     │
│  │   ▼ walk           ││    │ ┌───┐┌───┐┌───┐   │     │
│  │     ○ [img1.png] 0 ││    │ │   ││   ││   │   │     │
│  │     ○ [img2.png] 1 ││    │ └───┘└───┘└───┘   │     │
│  │   ▼ run            ││    │ ┌───┐             │     │
│  │     ○ [img3.png] 0 ││    │ │   │             │     │
│  │ ▼ enemy            ││    │ └───┘             │     │
│  │   ▼ idle           ││    └────────────────────┘     │
│  │     ○ [img4.png] 0 ││                               │
│  └─────────────────────┘│                               │
│                         │                               │
│  [+ 新建人物] [+ 新建动作]│   Padding: [2] px            │
│                         │   [导出 Atlas + JSON]         │
└─────────────────────────┴───────────────────────────────┘
```

### 分组命名规则

- 层级: 人物 > 动作 > 序号
- 导出格式: `{人物}_{动作}_{序号}`
- 示例: `player_walk_0`, `player_walk_1`, `enemy_idle_0`

### Padding 设置

- 图片间距设置（防止纹理采样边缘问题）
- 默认 2px

## 导出格式

### Phaser JSON Hash

```json
{
  "frames": {
    "player_walk_0": {
      "frame": {"x": 0, "y": 0, "w": 32, "h": 48},
      "sourceSize": {"w": 32, "h": 48},
      "spriteSourceSize": {"x": 0, "y": 0, "w": 32, "h": 48}
    },
    "player_walk_1": {
      "frame": {"x": 34, "y": 0, "w": 32, "h": 48}
    },
    "enemy_idle_0": { }
  },
  "meta": {
    "image": "atlas.png",
    "size": {"w": 256, "h": 128},
    "scale": 1
  }
}
```

## 项目结构

```
texturepack/
├── src-tauri/              # Rust 后端
│   ├── Cargo.toml
│   └── src/
│       ├── main.rs
│       ├── image_processor.rs   # 颜色消除、分割
│       └── atlas_packer.rs      # bin packing、JSON生成
├── src/                    # React 前端
│   ├── components/
│   │   ├── Preprocessor/        # 预处理模块
│   │   │   ├── ImageCanvas.tsx
│   │   │   ├── ColorPicker.tsx
│   │   │   └── SplitEditor.tsx
│   │   └── AtlasPacker/         # Atlas模块
│   │       ├── GroupManager.tsx
│   │       ├── AtlasPreview.tsx
│   │       └── ExportPanel.tsx
│   ├── App.tsx
│   └── main.tsx
├── package.json
└── docs/plans/
```

## 技术要点

### Rust 端

- **image crate**: 图像读写、像素操作
- **颜色消除**: 遍历像素，计算 RGB 欧氏距离，低于容差则设为透明
- **MaxRects 算法**: 高效的 bin packing 实现

### React 端

- **Canvas API**: 图片预览、分割线绘制
- **拖拽交互**: 分割线调整、帧排序
- **状态管理**: 图片数据、分组结构
